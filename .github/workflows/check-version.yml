name: Check Version
on: [push, pull_request]

jobs:
  check-version:
    name: Check Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Compare versions
        run: |
          function version { echo "$@" | awk -F. '{ printf("%04d%04d%04d\n", $1,$2,$3); }'; }

          mkdir build
          cd build
          source_version=`cmake .. | grep -o "PARLAY VERSION [0-9].[0-9].[0-9]" | grep -o "[0-9].[0-9].[0-9]"`
          source_major_version=`echo $source_version | awk '{split($0,a,"."); print a[1]}'`
          source_minor_version=`echo $source_version | awk '{split($0,a,"."); print a[2]}'`
          source_patch_version=`echo $source_version | awk '{split($0,a,"."); print a[3]}'`
          
          git checkout origin/master
          master_version=`cmake .. | grep -o "PARLAY VERSION [0-9].[0-9].[0-9]" | grep -o "[0-9].[0-9].[0-9]"`
          master_major_version=`echo $source_version | awk '{split($0,a,"."); print a[1]}'`
          master_minor_version=`echo $source_version | awk '{split($0,a,"."); print a[2]}'`
          master_patch_version=`echo $source_version | awk '{split($0,a,"."); print a[3]}'`

          if [ $(version $source_version) -le $(version $master_version) ]; then
            echo "Version number on the source branch ($source_version) must be greater than the master branch ($master_version)"
            exit 1
          fi

          let $master_major_version++
          let $master_minor_version++
          let $master_patch_version++
          
          if [ $source_major_version -gt $master_major_version ]; then
            echo "Major version number on the source branch ($source_version) increased by more than one compared to the master branch ($master_version)"
            exit 1
          fi
          
          if [ $source_minor_version -gt $master_minor_version ]; then
            echo "Minor version number on the source branch ($source_version) increased by more than one compared to the master branch ($master_version)"
            exit 1
          fi
          
          if [ $source_patch_version -gt $master_patch_version ]; then
            echo "Patch version number on the source branch ($source_version) increased by more than one compared to the master branch ($master_version)"
            exit 1
          fi
